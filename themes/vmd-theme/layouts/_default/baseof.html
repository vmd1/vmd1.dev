<!DOCTYPE html>
<html lang="en">
{{ partial "head.html" . }}
<body class="text-gray-300">
    <div id="loading-screen" class="fixed inset-0 z-[9999] flex flex-col items-center justify-center transition-opacity duration-500" style="background-color: var(--background-start);">
        <div class="flex flex-col items-center animate-pulse">
            <img src="https://cdn.848226.xyz/v1/vmd1/media/logo/logo.svg" alt="vmd1 logo" class="w-24 h-24 mb-4 rounded-full">
            <h1 class="text-4xl font-extrabold mb-8" style="color: var(--text-color);">vmd1</h1>
        </div>
        <div class="w-64 h-2 rounded-full overflow-hidden" style="background-color: var(--card-border);">
            <div id="loading-bar" class="h-full rounded-full w-0 transition-all duration-300 ease-out bg-gradient-to-r from-blue-500 to-purple-500" style="background: linear-gradient(to right, var(--primary-color), var(--secondary-color));"></div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadingBar = document.getElementById('loading-bar');
            let width = 0;
            const interval = setInterval(() => {
                if (width >= 90) {
                    clearInterval(interval);
                } else {
                    width += Math.random() * 10;
                    if (width > 90) width = 90;
                    loadingBar.style.width = width + '%';
                }
            }, 100);
        });

        window.addEventListener('load', () => {
            const loadingScreen = document.getElementById('loading-screen');
            const loadingBar = document.getElementById('loading-bar');
            
            // Ensure bar goes to 100%
            loadingBar.style.width = '100%';
            
            setTimeout(() => {
                loadingScreen.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    loadingScreen.remove();
                }, 500);
            }, 500);
        });
    </script>
    <div id="reading-progress" class="fixed top-0 left-0 h-1 bg-gradient-to-r from-blue-500 to-purple-500 z-[100] transition-all duration-100" style="width: 0%"></div>
    <div id="particles-js" aria-hidden="true"></div>
    <div id="background-logo" aria-hidden="true"></div>
    <div id="spotlight"></div>
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        {{ partial "header.html" . }}
        
        {{ block "main" . }}{{ end }}
        
        {{ partial "footer.html" . }}
    </div>

    <!-- Projects Modal -->
    <div id="projects-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div id="modal-content" class="bg-slate-900 p-8 rounded-lg max-w-4xl w-full max-h-[80vh] overflow-y-auto card">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-100">All Projects</h2>
                <button id="close-modal" class="text-gray-400 hover:text-gray-100">
                    <i class="ri-close-line text-2xl"></i>
                </button>
            </div>
            <div id="all-projects-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- All projects will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Projects Modal Logic
        const closeModalButton = document.getElementById('close-modal');
        const projectsModal = document.getElementById('projects-modal');
        const allProjectsContainer = document.getElementById('all-projects-container');
        const projectsNavLink = document.getElementById('projects-nav-link');

        function openModal() {
            projectsModal.classList.remove('hidden');
            fetchAllProjects();
        }

        function closeModal() {
            projectsModal.classList.add('hidden');
        }

        // Event delegation or check if element exists before adding listener
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'show-all-projects') {
                openModal();
            }
        });
        
        if (projectsNavLink) {
            projectsNavLink.addEventListener('click', (e) => {
                e.preventDefault();
                openModal();
            });
        }

        if (closeModalButton) {
            closeModalButton.addEventListener('click', closeModal);
        }

        if (projectsModal) {
            projectsModal.addEventListener('click', (e) => {
                if (e.target === projectsModal) {
                    closeModal();
                }
            });
        }

        async function fetchAllProjects() {
            const username = 'vmd1';
            try {
                allProjectsContainer.innerHTML = '<p class="text-gray-500">Loading GitHub repositories...</p>';
                
                const [ownedResponse] = await Promise.all([
                    fetch(`https://api.github.com/users/${username}/repos?sort=pushed`)
                ]);

                const ownedRepos = await ownedResponse.json();

                const allRepos = [...ownedRepos];
                
                // Simple duplicate removal by repo id
                const uniqueRepos = Array.from(new Set(allRepos.map(a => a.id)))
                    .map(id => {
                        return allRepos.find(a => a.id === id)
                    });

                allProjectsContainer.innerHTML = '';

                uniqueRepos.forEach(repo => {
                    const projectCard = `
                        <a href="${repo.html_url}" target="_blank" rel="noopener noreferrer" class="block p-6 bg-slate-800 rounded-lg hover:bg-slate-700 transition-colors duration-200 card">
                            <h3 class="text-xl font-bold text-gray-100 mb-2">${repo.full_name}</h3>
                            <p class="text-gray-400 text-sm mb-2">
                                <i class="ri-star-line"></i> ${repo.stargazers_count}
                                <i class="ri-git-repository-commits-line ml-4"></i> ${repo.forks_count}
                            </p>
                            <p class="text-gray-500 text-sm">${repo.description || 'No description available.'}</p>
                        </a>
                    `;
                    allProjectsContainer.innerHTML += projectCard;
                });
            } catch (error) {
                console.error('Error fetching all projects:', error);
                allProjectsContainer.innerHTML = '<p class="text-gray-500">Failed to load projects. Please try again later.</p>';
            }
        }
    </script>
    <script src="{{ "js/spotlight.js" | relURL }}"></script>
    <script src="{{ "js/code-copy.js" | relURL }}"></script>
    <script src="{{ "js/progress-bar.js" | relURL }}"></script>
    <script src="{{ "js/lightbox.js" | relURL }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (!window.particlesJS) return;
            window.particlesJS('particles-js', {
                particles: {
                    number: { value: 130, density: { enable: true, value_area: 900 } },
                    color: { value: ['#D8C2FF', '#F5A8E6', '#FFC3D2', '#B7C8FF'] },
                    shape: { type: 'circle' },
                    opacity: { value: 0.42, random: true },
                    size: { value: 2.8, random: true },
                    line_linked: {
                        enable: true,
                        distance: 155,
                        color: '#C8A8FF',
                        opacity: 0.28,
                        width: 1
                    },
                    move: {
                        enable: true,
                        speed: 1.5,
                        direction: 'none',
                        random: false,
                        straight: false,
                        out_mode: 'out'
                    }
                },
                interactivity: {
                    detect_on: 'window',
                    events: {
                        onhover: { enable: true, mode: 'repulse' },
                        onclick: { enable: true, mode: 'push' },
                        resize: true
                    },
                    modes: {
                        repulse: {
                            distance: 170,
                            duration: 0.45
                        },
                        push: {
                            particles_nb: 5
                        }
                    }
                },
                retina_detect: true
            });
        });
    </script>
    <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
      mermaid.initialize({ startOnLoad: false, theme: 'dark' });
      
      document.addEventListener('DOMContentLoaded', async () => {
          const mermaidBlocks = document.querySelectorAll('code.language-mermaid');
          if (mermaidBlocks.length > 0) {
              mermaidBlocks.forEach(block => {
                  const pre = block.parentElement;
                  const div = document.createElement('div');
                  div.className = 'mermaid';
                  div.textContent = block.textContent;
                  pre.replaceWith(div);
              });
              await mermaid.run();
          }
      });
    </script>
</body>
</html>
