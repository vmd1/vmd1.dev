<!-- What's On Section -->
<section class="card h-full">
    <h2 class="text-2xl font-semibold mb-4 text-gray-100">What's up?</h2>
    <div id="whats-on-content" class="prose text-gray-300 leading-relaxed">
        <p class="text-gray-500">Loading updates...</p>
    </div>

    <div class="mt-6 pt-4 border-t border-white/10 space-y-4 text-gray-300">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-100">GitHub Activity</h3>
            <span id="activity-today" class="text-sm text-gray-400">Activity today: loading...</span>
        </div>

        <div>
            <h4 class="text-sm font-semibold uppercase tracking-wide text-gray-400 mb-2">Last 3 commits</h4>
            <ul id="recent-commits" class="space-y-2 text-sm text-gray-300">
                <li class="text-gray-500">Loading commits...</li>
            </ul>
        </div>

        <div>
            <h4 class="text-sm font-semibold uppercase tracking-wide text-gray-400 mb-2">Contribution Graph</h4>
            <div id="contribution-graph" class="contribution-graph-card">
                <p class="text-gray-500 text-sm">Rendering contribution graph...</p>
            </div>
        </div>

        <div class="pt-2">
            <a id="random-project-link" href="https://github.com/vmd1?tab=repositories" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg bg-slate-800/50 hover:bg-slate-700 text-gray-200 hover:text-blue-400 border border-slate-700 hover:border-blue-500/50 transition-all duration-300">
                <i id="random-project-dice" class="ri-dice-line random-project-dice" aria-hidden="true"></i>
                <span class="font-semibold">Open a random project</span>
                <span aria-hidden="true">→</span>
            </a>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const username = 'vmd1';
        const whatsOnContentEl = document.getElementById('whats-on-content');
        const activityTodayEl = document.getElementById('activity-today');
        const recentCommitsEl = document.getElementById('recent-commits');
        const contributionGraphEl = document.getElementById('contribution-graph');
        const randomProjectLinkEl = document.getElementById('random-project-link');
        const randomProjectDiceEl = document.getElementById('random-project-dice');
        let candidateRepos = [];
        let currentRandomRepoUrl = '';
        let randomHoverTimeoutId = null;
        let randomHoverIntervalId = null;

        const pickRandomProject = () => {
            if (!randomProjectLinkEl || candidateRepos.length === 0) return;

            let randomRepo = candidateRepos[Math.floor(Math.random() * candidateRepos.length)];
            if (candidateRepos.length > 1) {
                while (randomRepo.html_url === currentRandomRepoUrl) {
                    randomRepo = candidateRepos[Math.floor(Math.random() * candidateRepos.length)];
                }
            }

            currentRandomRepoUrl = randomRepo.html_url;
            randomProjectLinkEl.href = randomRepo.html_url;
            randomProjectLinkEl.setAttribute('data-repo', randomRepo.full_name || '');
        };

        const rollDiceAndShuffle = () => {
            if (randomProjectDiceEl) {
                randomProjectDiceEl.classList.remove('rolling');
                void randomProjectDiceEl.offsetWidth;
                randomProjectDiceEl.classList.add('rolling');
            }
            pickRandomProject();
        };

        const clearRandomHoverTimers = () => {
            if (randomHoverTimeoutId) {
                clearTimeout(randomHoverTimeoutId);
                randomHoverTimeoutId = null;
            }
            if (randomHoverIntervalId) {
                clearInterval(randomHoverIntervalId);
                randomHoverIntervalId = null;
            }
        };

        if (randomProjectLinkEl) {
            randomProjectLinkEl.addEventListener('mouseenter', () => {
                clearRandomHoverTimers();
                randomHoverTimeoutId = setTimeout(() => {
                    rollDiceAndShuffle();
                    randomHoverIntervalId = setInterval(rollDiceAndShuffle, 1500);
                }, 1500);
            });

            randomProjectLinkEl.addEventListener('mouseleave', () => {
                clearRandomHoverTimers();
            });
        }

        if (whatsOnContentEl) {
            try {
                const markdownResponse = await fetch('https://raw.githubusercontent.com/vmd1/vmd1/refs/heads/main/whats-on.md');
                if (!markdownResponse.ok) throw new Error('Could not load markdown');
                const markdown = await markdownResponse.text();
                whatsOnContentEl.innerHTML = marked.parse(markdown || 'No updates yet.');
            } catch (error) {
                whatsOnContentEl.innerHTML = '<p class="text-gray-500">Couldn\'t load status updates right now.</p>';
            }
        }

        if (!activityTodayEl || !recentCommitsEl) return;

        const escapeHtml = (value) => String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');

        const renderContributionGraph = (events) => {
            if (!contributionGraphEl) return;

            const days = 30;
            const today = new Date();
            const start = new Date(today);
            start.setDate(today.getDate() - (days - 1));

            const byDay = new Map();
            for (let dayIndex = 0; dayIndex < days; dayIndex += 1) {
                const date = new Date(start);
                date.setDate(start.getDate() + dayIndex);
                const key = date.toISOString().slice(0, 10);
                byDay.set(key, 0);
            }

            events.forEach((event) => {
                if (!event || !event.created_at) return;
                const key = String(event.created_at).slice(0, 10);
                if (!byDay.has(key)) return;

                const current = byDay.get(key) || 0;
                if (event.type === 'PushEvent' && event.payload && Array.isArray(event.payload.commits)) {
                    byDay.set(key, current + Math.max(event.payload.commits.length, 1));
                } else {
                    byDay.set(key, current + 1);
                }
            });

            const data = Array.from(byDay.values());
            const maxValue = Math.max(...data, 5);

            const width = 760;
            const height = 250;
            const left = 42;
            const right = 18;
            const top = 26;
            const bottom = 34;
            const plotWidth = width - left - right;
            const plotHeight = height - top - bottom;

            const x = (index) => left + (index / (days - 1)) * plotWidth;
            const y = (value) => top + plotHeight - (value / maxValue) * plotHeight;

            const points = data.map((value, index) => `${x(index).toFixed(2)},${y(value).toFixed(2)}`).join(' ');

            const horizontalGrid = Array.from({ length: 6 }, (_, index) => {
                const value = (maxValue / 5) * index;
                const yPos = y(value);
                return `<line x1="${left}" y1="${yPos}" x2="${width - right}" y2="${yPos}" stroke="rgba(149,174,255,0.14)" stroke-width="1" />`;
            }).join('');

            const verticalGrid = Array.from({ length: 15 }, (_, index) => {
                const xPos = left + (index / 14) * plotWidth;
                return `<line x1="${xPos}" y1="${top}" x2="${xPos}" y2="${height - bottom}" stroke="rgba(149,174,255,0.1)" stroke-width="1" />`;
            }).join('');

            const circles = data.map((value, index) => {
                const cx = x(index).toFixed(2);
                const cy = y(value).toFixed(2);
                return `<circle cx="${cx}" cy="${cy}" r="2.5" fill="#97bbff" />`;
            }).join('');

            const xLabels = Array.from({ length: days }, (_, index) => {
                if (index % 2 !== 0 && index !== days - 1) return '';
                const labelDate = new Date(start);
                labelDate.setDate(start.getDate() + index);
                return `<text x="${x(index)}" y="${height - 10}" text-anchor="middle" fill="rgba(208,220,255,0.72)" font-size="9">${labelDate.getDate()}</text>`;
            }).join('');

            const yLabels = Array.from({ length: 6 }, (_, index) => {
                const value = Math.round((maxValue / 5) * (5 - index));
                const yPos = top + (plotHeight / 5) * index + 3;
                return `<text x="${left - 8}" y="${yPos}" text-anchor="end" fill="rgba(208,220,255,0.72)" font-size="9">${value}</text>`;
            }).join('');

            contributionGraphEl.innerHTML = `
                <svg viewBox="0 0 ${width} ${height}" role="img" aria-label="Vivaan's contribution graph" class="w-full h-auto">
                    ${horizontalGrid}
                    ${verticalGrid}
                    <polyline points="${points}" fill="none" stroke="#8eb5ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    ${circles}
                    ${xLabels}
                    ${yLabels}
                </svg>
            `;
        };

        try {
            const eventsResponse = await fetch(`https://api.github.com/users/${username}/events?per_page=100`);
            if (!eventsResponse.ok) throw new Error('GitHub API unavailable');

            const events = await eventsResponse.json();
            const todayUtc = new Date().toISOString().slice(0, 10);
            const todayActivityCount = events.filter((event) =>
                typeof event.created_at === 'string' && event.created_at.startsWith(todayUtc)
            ).length;

            renderContributionGraph(events);

            activityTodayEl.textContent = `Activity today: ${todayActivityCount} events`;

            const reposResponse = await fetch(`https://api.github.com/users/${username}/repos?sort=pushed&per_page=6`);
            if (!reposResponse.ok) throw new Error('Could not load repos');
            const repos = await reposResponse.json();

            if (randomProjectLinkEl) {
                candidateRepos = repos.filter((repo) => repo && repo.full_name && !repo.fork && repo.full_name !== 'vmd1/vmd1.dev');
                if (candidateRepos.length > 0) {
                    pickRandomProject();
                }
            }

            const commitResponses = await Promise.all(
                repos.map((repo) =>
                    fetch(`https://api.github.com/repos/${repo.full_name}/commits?author=${username}&per_page=3`)
                        .then((response) => (response.ok ? response.json() : []))
                        .catch(() => [])
                )
            );

            const commits = commitResponses
                .flat()
                .filter((commit) => commit && commit.sha && commit.commit && commit.commit.author)
                .map((commit) => ({
                    sha: commit.sha,
                    message: (commit.commit.message || 'Commit').split('\n')[0],
                    url: commit.html_url || `https://github.com/${commit.repository?.full_name || ''}/commit/${commit.sha}`,
                    repo: commit.repository && commit.repository.full_name
                        ? commit.repository.full_name
                        : (commit.url?.match(/repos\/(.+?)\/commits/)?.[1] || 'Unknown repo'),
                    date: commit.commit.author.date
                }))
                .filter((commit) => commit.repo !== 'vmd1/vmd1.dev')
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const seen = new Set();
            const latestThree = commits.filter((commit) => {
                if (seen.has(commit.sha)) return false;
                seen.add(commit.sha);
                return true;
            }).slice(0, 3);
            if (latestThree.length === 0) {
                recentCommitsEl.innerHTML = '<li class="text-gray-500">No recent public commits found.</li>';
                return;
            }

            recentCommitsEl.innerHTML = latestThree.map((commit) => (
                `<li class="leading-relaxed">` +
                `<a href="${escapeHtml(commit.url)}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-blue-300">${escapeHtml(commit.message)}</a>` +
                `<span class="text-gray-500"> · ${escapeHtml(commit.repo)}</span>` +
                `</li>`
            )).join('');
        } catch (error) {
            activityTodayEl.textContent = 'Activity today: unavailable';
            recentCommitsEl.innerHTML = '<li class="text-gray-500">Couldn\'t load commit activity right now.</li>';
            if (contributionGraphEl) {
                contributionGraphEl.innerHTML = '<p class="text-gray-500 text-sm">Couldn\'t render contribution graph right now.</p>';
            }
        }
    });
</script>